var Events={nextID:0,updateBucketsFor:function(section,reset){var skipAside=section=='credit_options';var acctField=$('account_for_'+section);var disabled=acctField.tagName=="SELECT"&&$F(acctField).empty();var acctId=disabled?null:$F(acctField);Events.getBucketSelects(section).each(function(bucketSelect){Events.populateBucket(bucketSelect,acctId,{'reset':reset,'disabled':disabled,'skipAside':skipAside});});},populateBucket:function(select,acctId,options){options=options||{};var selected=undefined;if(select.selectedIndex>=0)
selected=select.options[select.selectedIndex].value;for(var i=0;i<select.options.length;i++){select.options[0]=null;}
if(options['disabled']){select.disabled=true;select.options[0]=new Option("-- Select an account --","");}else{select.disabled=false;i=0;Events.accounts[acctId].buckets.each(function(bucket){if(bucket.role!='aside'||!options.skipAside){select.options[i++]=new Option(bucket.name,bucket.id);}})
if(select.hasClassName("splittable")){select.options[i++]=new Option("-- More than one --","+");}
select.options[i++]=new Option("-- Add a new bucket --","++");if(!options['reset'])Events.selectBucket(select,selected);}},sectionWantsCreditOptions:function(section){return section=='payment_source';},sectionWantsCheckOptions:function(section){return(section=='payment_source'||section=='transfer_from'||section=='deposit');},handleAccountChange:function(select,section){$(section+'.multiple_buckets').hide();$(section+'.line_items').innerHTML="";$(section+'.single_bucket').show();Events.updateBucketsFor(section,true);if(Events.sectionWantsCreditOptions(section)){$(section+'.repayment_options').hide();$('credit_options').hide();}
if(Events.sectionWantsCheckOptions(section))$(section+'.check_options').hide();if(!$F(select).empty()){var acctId=parseInt(select.options[select.selectedIndex].value);var account=Events.accounts[acctId];switch(account.role){case'credit-card':if(Events.sectionWantsCreditOptions(section))
$(section+'.repayment_options').show();break;case'checking':if(Events.sectionWantsCheckOptions(section))
$(section+'.check_options').show();break;}}},showRepaymentOptions:function(section){$(section+'.repayment_options').hide();$('credit_options').show();},bucketComparer:function(a,b){if(a.name==b.name)return 0;if(a.name<b.name)return-1;return 1;},handleBucketChange:function(select,section){var selected=select.options[select.selectedIndex].value;if(selected=='+'){Events.addLineItemTo(section);Events.addLineItemTo(section);$(section+'.multiple_buckets').show();$(section+'.single_bucket').hide();Events.updateBucketsFor(section);$(section+'.multiple_buckets').down('input').activate();}else if(selected=='++'){var acctId=$F('account_for_'+section);var name=prompt('Name your new bucket:');if(name){var value="n:"+name;Events.accounts[acctId].buckets.push({'id':value,'name':name});Events.accounts[acctId].buckets.sort(Events.bucketComparer);Events.updateBucketsFor(section);Events.selectBucket(select,value);}else{select.selectedIndex=0;}}},selectBucket:function(select,value){for(var i=0;i<select.options.length;i++){if(select.options[i].value==value){select.selectedIndex=i;break;}}},getBucketSelects:function(section){return $$('#'+section+' select.bucket_for_'+section);},addLineItemTo:function(section,populate){var ol=$(section+".line_items");var li=document.createElement("li");li.innerHTML=$('template.'+section).innerHTML;ol.appendChild(li);var input=li.down("input");if(populate){var acctSelect=$('account_for_'+section);var acctId=$F('account_for_'+section);var bucketSelect=li.down("select");Events.populateBucket(bucketSelect,acctId,{'skipAside':(section=='credit_options')});if(populate!=true){bucketSelect.setValue(populate.bucket_id);input.setValue(Money.formatValue(Math.abs(populate.amount)));}}
input.focus();},removeLineItem:function(li){li.remove();Events.updateUnassigned();},addTaggedItem:function(item){var ol=$('tagged_items');var li=document.createElement("li");var content=$('template.tags').innerHTML;var id="tagged_item_i"+String(Events.nextID++);li.innerHTML=content.gsub(/\{ID\}/,id);ol.appendChild(li);Events.autocompleteTagField(id);li.down("input").focus();if(item){li.down("input.number").setValue(Money.formatValue(item.amount));li.down("input.tag").setValue(item.name);}},autocompleteTagField:function(id,options){options=options||{};options.frequency=options.frequency||0.2;options.onHide=options.onHide||function(element,update){new Effect.Fade(update,{duration:0.15,afterFinish:function(){update.innerHTML="";}})}
new Autocompleter.Local(id,id+"_select",Events.tags,options);},autocompleteActorField:function(options){options=options||{};options.frequency=options.frequency||0.2;options.onHide=options.onHide||function(element,update){new Effect.Fade(update,{duration:0.15,afterFinish:function(){update.innerHTML="";}})}
new Autocompleter.Local('event_actor_name',"event_actor_name_select",Events.actors,options);var element=$('event_actor_name');element.observe('keyup',function(){Events.recalledEvents=null;if(element.present()){$('recall_event').show();}else{$('recall_event').hide();}});},removeTaggedItem:function(li){li.remove();},updateUnassigned:function(){$('success_notice').hide();Events.updateUnassignedFor('payment_source');Events.updateUnassignedFor('credit_options');Events.updateUnassignedFor('deposit');Events.updateUnassignedFor('transfer_from');Events.updateUnassignedFor('transfer_to');},computeTotalForLineItems:function(section){var total=0;var line_items=$(section+".line_items");line_items.select("input[type=text]").each(function(field){total+=Money.parse(field);});return total;},computeUnassignedFor:function(section){var total=Money.parse('expense_total');var unassigned=total-Events.computeTotalForLineItems(section);return{'total':total,'unassigned':unassigned};},updateUnassignedFor:function(section){if(!$(section))return;var money=Events.computeUnassignedFor(section)
if(money.unassigned>0){$(section+".unassigned").innerHTML="<strong>$"+Money.dollars(money.unassigned)+"</strong> of $"+Money.dollars(money.total)+" remains unallocated.";}else if(money.unassigned<0){$(section+".unassigned").innerHTML="You've overallocated <strong>$"+Money.dollars(money.unassigned)+"</strong>.";}else{$(section+".unassigned").innerHTML="";}},encodeXML:function(str){return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/'/g,'&apos;').replace(/"/g,'&quot;');},buildXMLStringFor:function(request){var xml="";for(var key in request){tag=key.replace("_","-");xml+=Events.buildXMLFor(tag,request[key]);}
return xml;},buildXMLFor:function(tag,value){var xml="";if(Object.isArray(value)){xml+="<"+tag+"s type='array'>";value.each(function(element){xml+=Events.buildXMLFor(tag,element);});xml+="</"+tag+"s>";}else if(typeof value=="object"){xml+="<"+tag+">"+Events.buildXMLStringFor(value)+"</"+tag+">";}else{xml+="<"+tag+">"+Events.encodeXML(String(value))+"</"+tag+">";}
return xml;},available:function(section){return $(section)&&$(section).visible();},sections:{payment_source:{expense:true},credit_options:{expense:true},deposit:{expense:false},transfer_from:{expense:true},transfer_to:{expense:false},reallocate_from:{expense:false,reallocation:true},reallocate_to:{expense:true,reallocation:true}},serialize:function(parent){var request={};request['event']={};request['event']['line_item']=[];request['event']['tagged_item']=[];if(Events.available('general_information'))
Events.serializeGeneralInformation(request);else{request['event']['occurred_on']=Events.defaultDate;request['event']['actor_name']=Events.defaultActor;}
for(section in Events.sections){if(Events.available(section))
Events.serializeSection(request,section,Events.sections[section]);}
Events.serializeTags(request);return request;},addToRequest:function(request,name,value){if(name.match(/^\w+$/)){request[name]=value;}else{var parts=name.replace("][",",").replace("[",",").replace("]","").split(/,/);var n=0;while(n<parts.length-1){var part=parts[n];request[part]=request[part]||{};request=request[part];n++;}
request[parts[n]]=value;}},serializeGeneralInformation:function(request){Form.getElements('general_information').each(function(field){if(!field.name.blank()&&field.name!="amount")
Events.addToRequest(request,field.name,field.value);});},serializeSection:function(request,section,options){options=options||{};var account_id=$F('account_for_'+section);if($('expense_total')){var total=Money.parse('expense_total');var expense=(options.expense?-1:1)*total;}
if(Events.sectionWantsCheckOptions(section)&&$(section+'.check_options').visible()){request['event']['check_number']=$F($(section+'.check_options').down('input'));}
single=$(section+'.single_bucket');if(single&&single.visible()){var bucket_id=$F($(section+'.single_bucket').down('select'));Events.addLineItem(request,account_id,bucket_id,expense,section);value=expense;}else{value=Events.addLineItems(request,account_id,section,options);}
if(options.reallocation){var bucket_id=$F($(section).down('p.primary').down('select'));Events.addLineItem(request,account_id,bucket_id,-value,'primary');}
if(section=='credit_options'){Events.addLineItem(request,account_id,'r:aside',total,'aside');}},serializeTags:function(request){if($('tags').visible()){Events.serializeEventTags(request);if($('tag_items').visible())
Events.serializeItemTags(request);}},serializeEventTags:function(request){var tagList=$F('event_tags_list').strip();if(tagList.empty())return;var total=Events.computeTotal();tagList.split(",").each(function(name){Events.addTaggedItemRecord(request,total,"n:"+name.strip());});},serializeItemTags:function(request){$('tagged_items').select('li').each(function(row){var name=$F(row.down('input.tag')).strip();if(name.length>0){var amount=Money.parse(row.down('input.number'));Events.addTaggedItemRecord(request,amount,"n:"+name);}});},computeTotal:function(){if($('reallocate_to')&&$('reallocate_to').visible()){return Events.computeTotalForLineItems('reallocate_to');}else if($('reallocate_from')&&$('reallocate_from').visible()){return Events.computeTotalForLineItems('reallocate_from');}else{return Money.parse('expense_total');}},addTaggedItemRecord:function(request,amount,tag_id){var item={amount:amount,tag_id:tag_id};request['event']['tagged_item'].push(item);},addLineItem:function(request,account_id,bucket_id,amount,role){var item={account_id:account_id,bucket_id:bucket_id,amount:amount,role:role};request['event']['line_item'].push(item);},addLineItems:function(request,account_id,section,options){options=options||{};value=0;$(section+'.line_items').select('li').each(function(row){bucket_id=$F(row.down('select'));field=row.down('input[type=text]');if(field.present()){amount=(options.expense?-1:1)*Money.parse(field);value+=amount;Events.addLineItem(request,account_id,bucket_id,amount,section);}});return value;},submit:function(form){try{var options={};var action=form.readAttribute('action');options.method="post";options.contentType="application/xml";options.postBody=Events.buildXMLStringFor(Events.serialize(form));return new Ajax.Request(action,options);}catch(e){alert(e);}},highlightLink:function(id){$('links').select('a').each(function(link){if(link.id==id){link.addClassName('highlight');}else{link.removeClassName('highlight');}})},revealMemo:function(){$('memo_link').hide();$('memo').show();$('memo').down('textarea').focus();},revealBasicForm:function(){$('new_event').show();$('success_notice').hide();$$('.expense_label').invoke('hide');$$('.deposit_label').invoke('hide');$$('.transfer_label').invoke('hide');$('general_information').show();$('payment_source').hide();$('credit_options').hide();$('deposit').hide();$('transfer_from').hide();$('transfer_to').hide();$('reallocate_from').hide();$('reallocate_to').hide();$('event_occurred_on').activate();},revealExpenseForm:function(){Events.highlightLink('expense_link');Events.revealBasicForm();$$('.expense_label').invoke('show');$('payment_source').show();},revealDepositForm:function(){Events.highlightLink('deposit_link');Events.revealBasicForm();$$('.deposit_label').invoke('show');$('deposit').show();},revealTransferForm:function(){Events.highlightLink('transfer_link');Events.revealBasicForm();$$('.transfer_label').invoke('show');$('transfer_from').show();$('transfer_to').show();},revealReallocationForm:function(direction,account_id,bucket_id){Events.revealBasicForm();$('general_information').hide();var section='reallocate_'+direction;$('account_for_'+section).value=account_id;$(section+".line_items").innerHTML="";$(section).show();Events.updateBucketsFor(section);Events.selectBucket($(section).down('select'),bucket_id);Events.addLineItemTo(section,true);},resetReallocationForm:function(direction){var section='reallocate_'+direction;if($(section).visible()){$(section+".line_items").innerHTML="";Events.addLineItemTo(section,true);}},revealTags:function(){$('tags_collapsed').hide();$('tags').show();$('tags').down("input").focus();},revealPartialTags:function(bare){if(!bare){Events.addTaggedItem();Events.addTaggedItem();}
$('tag_items_collapsed').hide();$('tag_items').show();if(!bare){$('tag_items').down('input').focus();}},reset:function(){$('event_form').reset();['credit_options','payment_source','deposit','transfer_from','transfer_to'].each(function(section){Events.handleAccountChange($('account_for_'+section),section);});['from','to'].each(function(direction){Events.resetReallocationForm(direction);});if($('memo')){$('memo').hide();$('memo_link').show();}
$('tag_items').hide();$('tag_items_collapsed').show();$('tagged_items').innerHTML="";$('tags').hide();$('tags_collapsed').show();$('recall_event').hide();},cancel:function(){if(Events.return_to){Events.returnToCaller();}else{Events.highlightLink("");Events.reset();$('new_event').hide();}},expand:function(id){if($('zoomed_event_'+id))return false;$('event_'+id).addClassName('zooming');},expanded:function(id){$('event_'+id).removeClassName('zooming');$('event_'+id).addClassName('zoomed');},collapse:function(id){$('event_'+id).removeClassName('zoomed');$('zoomed_event_'+id).remove();},onMouseOver:function(id){$('event_'+id).addClassName("hover");var nubbin=$('nubbin_event_'+id);var offset=nubbin.up("tr").cumulativeOffset();nubbin.show();nubbin.style.left=(offset.left-nubbin.getWidth())+"px";},onMouseOut:function(id){$('event_'+id).removeClassName("hover");$('nubbin_event_'+id).hide();},deleteEvent:function(url,token){if(confirm("Do you wish to delete this transaction?")){parameters='authenticity_token='+encodeURIComponent(token)+'&'+'from='+encodeURIComponent(Events.source);new Ajax.Request(url,{asynchronous:true,evalScripts:true,method:'delete',parameters:parameters});}},edit:function(url){var return_to=window.location.pathname;window.location=url+"?return_to="+encodeURIComponent(return_to);},destroy:function(id){var table=$('event_'+id).up('table');$('event_'+id).remove();if($('zoomed_event_'+id))$('zoomed_event_'+id).remove();var i=1;table.select('tr').each(function(row){if(i>2){row.removeClassName('odd').removeClassName('even');if(i%2==0)
row.addClassName('even');else
row.addClassName('odd');}
i++;})},returnToCaller:function(){window.location.href=Events.return_to;},recallEvent:function(url){if(!Events.recalledEvents){Events.loadRecalledEvents(url);return;}
if(Events.recalledEvents.length==0){alert("No transactions matched the criteria you specified.");return;}
Events.currentEvent=(Events.currentEvent+1)%Events.recalledEvents.length;var event=Events.recalledEvents[Events.currentEvent].event;Events.rehydrate(event);},loadRecalledEvents:function(url){parameters='page=0&size=10&actor='+encodeURIComponent($F('event_actor_name'));new Ajax.Request(url,{asynchronous:true,evalScripts:true,method:'get',parameters:parameters});},doneLoadingRecalledEvents:function(events){Events.recalledEvents=events;Events.currentEvent=-1;Events.recallEvent();},rehydrate:function(event){var saved_date=$F('event_occurred_on');var saved_actor=$F('event_actor_name');Events.reset();$('event_occurred_on').value=saved_date;$('event_actor_name').value=saved_actor;$('expense_total').value=Money.formatValue(event.value);$('event_memo').value=event.memo;if($('event_memo').present())Events.revealMemo();$('recall_event').show();switch(event.role){case"expense":Events.rehydrateExpenseEvent(event);break;case"deposit":Events.rehydrateDepositEvent(event);break;case"transfer":Events.rehydrateTransferEvent(event);break;case"reallocation":alert("Not yet implemented: can't rehydrate bucket reallocations");return;default:alert("Can't rehydrate '"+event.role+"' events");return;}
Events.rehydrateTagsForEvent(event);},rehydrateSection:function(section,event){var items=event.line_items.select(function(item){return item.role==section;});if(items.length==0)return;$(section).show();var account=Events.accounts[items[0].account_id];$('account_for_'+section).setValue(account.id);if(account.role=="checking"&&Events.sectionWantsCheckOptions(section)){$(section+'.check_options').show();$('event_check_number').setValue(event.check_number);}
Events.updateBucketsFor(section);if(items.length==1){var select=$(section+'.single_bucket').down('select');Events.selectBucket(select,items[0].bucket_id);}else{$(section+'.multiple_buckets').show();$(section+'.single_bucket').hide();items.each(function(item){Events.addLineItemTo(section,item);});}},rehydrateExpenseEvent:function(event){Events.revealExpenseForm();Events.rehydrateSection('payment_source',event);Events.rehydrateSection('credit_options',event);},rehydrateDepositEvent:function(event){Events.revealDepositForm();Events.rehydrateSection('deposit',event);},rehydrateTransferEvent:function(event){Events.revealTransferForm();Events.rehydrateSection('transfer_from',event);Events.rehydrateSection('transfer_to',event);},rehydrateTagsForEvent:function(event){var whole_tags=$A(),partial_tags=$A();event.tagged_items.each(function(item){if(item.amount<event.value){partial_tags.push(item);}else{whole_tags.push(item);}});if(whole_tags.length>0||partial_tags.length>0){Events.revealTags();if(whole_tags.length>0){var tags=whole_tags.map(function(item){return item.name}).join(", ")
$('tags').down('input').setValue(tags);}
if(partial_tags.length>0){Events.revealPartialTags(true);partial_tags.each(function(item){Events.addTaggedItem(item);});}}}}
var Accounts={revealForm:function(){if($('blankslate')){$('blankslate').hide();}else{$('data').hide();$('links').hide();}
$('new_account').show();$('account_name').activate();},hideForm:function(){if(Accounts.origin){window.location=Accounts.origin;}else{Accounts.reset();$('new_account').hide();if($('blankslate')){$('blankslate').show();}else{$('data').show();$('links').show();}}},submit:function(){if($F('account_name').blank()){$('account_name').activate();alert('Please provide a name for the account.');return false;}
if($F('account_role')=='credit-card'&&$F('account_limit').blank()){$('account_name').activate();alert('Please provide a limit for the account.');return false;}
var balance=Money.parse('current_balance',true);$('account_starting_balance_amount').value=balance;var limit=Money.parse('account_limit',true);$('account_limit').value=limit;return true;},reset:function(){$('new_account_form').reset();},rename:function(url,name,token){new_name=prompt("Enter the name for this account:",name);if(new_name&&new_name!=name){params=encodeURIComponent("account[name]")+"="+encodeURIComponent(new_name)+"&authenticity_token="+encodeURIComponent(token);new Ajax.Request(url,{asynchronous:true,evalScripts:true,method:'put',parameters:params});}},adjustLimit:function(url,limit,token){new_limit=prompt("Enter the new limit for this account:",Money.formatValue(limit));new_limit=Money.parseValue(new_limit);while(new_limit==''){new_limit=prompt("Cannot have have a blank limit. Please re-enter it:",Money.formatValue(limit));}
if(new_limit&&new_limit!=limit){params=encodeURIComponent("account[limit]")+"="+encodeURIComponent(new_limit)+"&authenticity_token="+encodeURIComponent(token);new Ajax.Request(url,{asynchronous:true,evalScripts:true,method:'put',parameters:params,onSuccess:function(request){window.location.reload();}});}},showOrHideCreditLimit:function(value){if(value=='credit-card'){Accounts.showCreditLimit();}else{Accounts.hideCreditLimit();}},showCreditLimit:function(){$('credit_limit_div').show();},hideCreditLimit:function(){$('credit_limit_div').hide();}}
var Statements={clickItem:function(id){$('check_account_item_'+id).click();},toggleCleared:function(id){var checked=$('check_account_item_'+id).checked;var amount=parseInt($('amount_account_item_'+id).innerHTML);var subtotalField=$('account_item_'+id).up('fieldset').down('.subtotal_dollars');var subtotal=Money.parseValue(subtotalField.innerHTML,true);if(checked){$('account_item_'+id).addClassName('cleared');subtotalField.innerHTML="$"+Money.formatValue(subtotal+amount);}else{$('account_item_'+id).removeClassName('cleared');subtotalField.innerHTML="$"+Money.formatValue(subtotal-amount);}
Statements.updateBalances();},startingBalance:function(){if(!Statements.cachedBalance)
Statements.cachedBalance=Money.parseValue($('starting_balance').innerHTML,true);return Statements.cachedBalance;},endingBalance:function(){return Money.parse($('statement_ending_balance'),true);},settled:function(){return $$('.subtotal_dollars').inject(0,function(sum,span){return sum+Money.parseValue(span.innerHTML,true);});},remaining:function(){return Statements.startingBalance()+Statements.settled()-Statements.endingBalance();},updateBalances:function(){var ending=$('statement_ending_balance');ending.value=Money.format(ending);var remaining=Statements.remaining();var remainingText=Money.formatValue(remaining);['deposits','checks','expenses'].each(function(section){if($(section)){var span=$$("#"+section+" .remaining_dollars").first();if(remaining==0)
span.addClassName("balanced");else
span.removeClassName("balanced");span.innerHTML="$"+remainingText;}})
if(remaining==0){$('balanced').show();$('actions').hide();}else{$('balanced').hide();$('actions').show();}}}
var Money={dollars:function(cents,keepNegative){cents=keepNegative?cents:Math.abs(cents);return(cents/100).toFixed(2);},parse:function(field,keepNegative){return Money.parseValue($F(field),keepNegative);},parseValue:function(string,keepNegative){var value=string.gsub(/[^-+\d.]/,"");var match=value.match(/^([-+]?)(\d*)(?:\.(\d*))?$/);if(!match)return 0;var sign=((match[1]=="-")&&keepNegative)?-1:1;if(match[2].length>0)
var dollars=parseInt(match[2]);else
var dollars=0;if(match[3]&&match[3].length>0){var cents_magnitude=Math.pow(10,match[3].length);var cents_text=match[3].sub(/^0+/,"");if(cents_text.blank())cents_text="0";var cents=Math.round(parseInt(cents_text)*100/cents_magnitude);}else{var cents=0;}
return sign*(dollars*100+cents);},format:function(field){return Money.formatValue(Money.parse(field,true));},formatValue:function(cents){var sign=cents<0?-1:1;var source=String(Math.abs(cents));var result;if(source.length>2){result="."+source.slice(-2);source=source.slice(0,-2);}else if(source.length==2){result="."+source;source="";}else if(source.length==1){result=".0"+source;source="";}else{result=".00";}
while(source.length>3){result=","+source.slice(-3)+result;source=source.slice(0,-3);}
if(source.length>0){result=source+result;}else if(result[0]=="."){result="0"+result;}
if(sign<0){result="-"+result;}
return result;}}
var Buckets={onMouseOver:function(id){var nubbin=$('nubbin_bucket_'+id);var offset=nubbin.up("tr").cumulativeOffset();nubbin.show();nubbin.style.left=(offset.left-nubbin.getWidth())+"px";},onMouseOut:function(id){$('nubbin_bucket_'+id).hide();},configureEvent:function(){Events.defaultDate=new Date().toFormattedString();Events.defaultActor="Bucket reallocation";},transferTo:function(account_id,bucket_id){if(Buckets.newEventUrl){window.location=Buckets.newEventUrl+"?role=reallocation&to="+bucket_id;}else{Buckets.configureEvent();Events.revealReallocationForm('to',account_id,bucket_id);}},transferFrom:function(account_id,bucket_id){if(Buckets.newEventUrl){window.location=Buckets.newEventUrl+"?role=reallocation&from="+bucket_id;}else{Buckets.configureEvent();Events.revealReallocationForm('from',account_id,bucket_id);}},view:function(){if($$('tr.bucket').any()){return'index';}else{return'perma';}},rename:function(url,name,token){new_name=prompt("Enter the name for this bucket:",name);if(new_name&&new_name!=name){params=encodeURIComponent("bucket[name]")+"="+encodeURIComponent(new_name)+"&authenticity_token="+encodeURIComponent(token)+"&view="+Buckets.view();new Ajax.Request(url,{asynchronous:true,evalScripts:true,method:'put',parameters:params});}},deleteBucket:function(){$('data').hide();$('delete_form').show();},confirmDelete:function(){return confirm("Are you sure you want to delete this bucket?");},cancelDelete:function(){$('delete_form').hide();$('data').show();}}
var Tags={rename:function(url,name,token){new_name=prompt("Enter the name for this tag:",name);if(new_name&&new_name!=name){params=encodeURIComponent("tag[name]")+"="+encodeURIComponent(new_name)+"&authenticity_token="+encodeURIComponent(token);new Ajax.Request(url,{asynchronous:true,evalScripts:true,method:'put',parameters:params});}},deleteTag:function(){if($('delete_form').down('fieldset')){$('delete_form').show();$('data').hide();}else if(confirm("Are you sure want to delete this tag?")){$('delete_form').down('form').submit();}},confirmDelete:function(){if($('mergeTagOption').down('input').checked){if($('receiver_id').selectedIndex<=0){alert("If you want to merge tags, you must select a tag to merge with.");$('receiver_id').focus();return false;}}else{$('receiver_id').selectedIndex=0;}
return confirm("Are you sure you want to delete this tag?");},cancelDelete:function(){$('delete_form').down('form').reset();Tags.selectDeleteTag();$('delete_form').hide();$('data').show();},selectDeleteTag:function(){$('receiver_id').selectedIndex=0;$('deleteTagOption').addClassName('selected');$('mergeTagOption').removeClassName('selected');},selectMergeTag:function(){$('mergeTagOption').addClassName('selected');$('deleteTagOption').removeClassName('selected');}}
var Filters={display:function(){var form=$('filter_form');var nub=$('filter_nubbin');form.show();form.style.left=(nub.offsetLeft+nub.getWidth()-form.getWidth())+"px";},hide:function(){$('filter_form').hide();}}
if(typeof Prototype=='undefined')alert("CalendarDateSelect Error: Prototype could not be found. Please make sure that your application's layout includes prototype.js (.g. <%= javascript_include_tag :defaults %>) *before* it includes calendar_date_select.js (.g. <%= calendar_date_select_includes %>).");if(Prototype.Version<"1.6")alert("Prototype 1.6.0 is required.  If using earlier version of prototype, please use calendar_date_select version 1.8.3");Element.addMethods({purgeChildren:function(element){$A(element.childNodes).each(function(e){$(e).remove();});},build:function(element,type,options,style){var newElement=Element.buildAndAppend(type,options,style);element.appendChild(newElement);return newElement;}});Element.buildAndAppend=function(type,options,style)
{var e=$(document.createElement(type));$H(options).each(function(pair){e[pair.key]=pair.value});if(style)e.setStyle(style);return e;};nil=null;Date.one_day=24*60*60*1000;Date.weekdays=$w("S M T W T F S");Date.first_day_of_week=0;Date.months=$w("January February March April May June July August September October November December");Date.padded2=function(hour){var padded2=parseInt(hour,10);if(hour<10)padded2="0"+padded2;return padded2;}
Date.prototype.getPaddedMinutes=function(){return Date.padded2(this.getMinutes());}
Date.prototype.getAMPMHour=function(){var hour=this.getHours();return(hour==0)?12:(hour>12?hour-12:hour)}
Date.prototype.getAMPM=function(){return(this.getHours()<12)?"AM":"PM";}
Date.prototype.stripTime=function(){return new Date(this.getFullYear(),this.getMonth(),this.getDate());};Date.prototype.daysDistance=function(compare_date){return Math.round((compare_date-this)/Date.one_day);};Date.prototype.toFormattedString=function(include_time){var hour,str;str=Date.months[this.getMonth()]+" "+this.getDate()+", "+this.getFullYear();if(include_time){hour=this.getHours();str+=" "+this.getAMPMHour()+":"+this.getPaddedMinutes()+" "+this.getAMPM()}
return str;}
Date.parseFormattedString=function(string){return new Date(string);}
Math.floor_to_interval=function(n,i){return Math.floor(n/i)*i;}
window.f_height=function(){return([window.innerHeight?window.innerHeight:null,document.documentElement?document.documentElement.clientHeight:null,document.body?document.body.clientHeight:null].select(function(x){return x>0}).first()||0);}
window.f_scrollTop=function(){return([window.pageYOffset?window.pageYOffset:null,document.documentElement?document.documentElement.scrollTop:null,document.body?document.body.scrollTop:null].select(function(x){return x>0}).first()||0);}
_translations={"OK":"OK","Now":"Now","Today":"Today","Clear":"Clear"}
SelectBox=Class.create();SelectBox.prototype={initialize:function(parent_element,values,html_options,style_options){this.element=$(parent_element).build("select",html_options,style_options);this.populate(values);},populate:function(values){this.element.purgeChildren();var that=this;$A(values).each(function(pair){if(typeof(pair)!="object"){pair=[pair,pair]};that.element.build("option",{value:pair[1],innerHTML:pair[0]})});},setValue:function(value){var e=this.element;var matched=false;$R(0,e.options.length-1).each(function(i){if(e.options[i].value==value.toString()){e.selectedIndex=i;matched=true;};});return matched;},getValue:function(){return $F(this.element)}}
CalendarDateSelect=Class.create();CalendarDateSelect.prototype={initialize:function(target_element,options){this.target_element=$(target_element);if(!this.target_element){alert("Target element "+target_element+" not found!");return false;}
if(this.target_element.tagName!="INPUT")this.target_element=this.target_element.down("INPUT")
this.target_element.calendar_date_select=this;this.last_click_at=0;this.options=$H({embedded:false,popup:nil,time:false,buttons:true,clear_button:true,year_range:10,close_on_click:nil,minute_interval:5,popup_by:this.target_element,month_year:"dropdowns",onchange:this.target_element.onchange,valid_date_check:nil}).merge(options||{});this.use_time=this.options.get("time");this.parseDate();this.callback("before_show")
this.initCalendarDiv();if(!this.options.get("embedded")){this.positionCalendarDiv()
Event.observe(document,"mousedown",this.closeIfClickedOut_handler=this.closeIfClickedOut.bindAsEventListener(this));Event.observe(document,"keypress",this.keyPress_handler=this.keyPress.bindAsEventListener(this));}
this.callback("after_show")},positionCalendarDiv:function(){var above=false;var c_pos=this.calendar_div.cumulativeOffset(),c_left=c_pos[0],c_top=c_pos[1],c_dim=this.calendar_div.getDimensions(),c_height=c_dim.height,c_width=c_dim.width;var w_top=window.f_scrollTop(),w_height=window.f_height();var e_dim=$(this.options.get("popup_by")).cumulativeOffset(),e_top=e_dim[1],e_left=e_dim[0],e_height=$(this.options.get("popup_by")).getDimensions().height,e_bottom=e_top+e_height;if(((e_bottom+c_height)>(w_top+w_height))&&(e_bottom-c_height>w_top))above=true;var left_px=e_left.toString()+"px",top_px=(above?(e_top-c_height):(e_top+e_height)).toString()+"px";this.calendar_div.style.left=left_px;this.calendar_div.style.top=top_px;this.calendar_div.setStyle({visibility:""});if(navigator.appName=="Microsoft Internet Explorer")this.iframe=$(document.body).build("iframe",{src:"javascript:false",className:"ie6_blocker"},{left:left_px,top:top_px,height:c_height.toString()+"px",width:c_width.toString()+"px",border:"0px"})},initCalendarDiv:function(){if(this.options.get("embedded")){var parent=this.target_element.parentNode;var style={}}else{var parent=document.body
var style={position:"absolute",visibility:"hidden",left:0,top:0}}
this.calendar_div=$(parent).build('div',{className:"calendar_date_select"},style);var that=this;$w("top header body buttons footer bottom").each(function(name){eval("var "+name+"_div = that."+name+"_div = that.calendar_div.build('div', { className: 'cds_"+name+"' }, { clear: 'left'} ); ");});this.initHeaderDiv();this.initButtonsDiv();this.initCalendarGrid();this.updateFooter("&#160;");this.refresh();this.setUseTime(this.use_time);},initHeaderDiv:function(){var header_div=this.header_div;this.close_button=header_div.build("a",{innerHTML:"x",href:"#",onclick:function(){this.close();return false;}.bindAsEventListener(this),className:"close"});this.next_month_button=header_div.build("a",{innerHTML:"&gt;",href:"#",onclick:function(){this.navMonth(this.date.getMonth()+1);return false;}.bindAsEventListener(this),className:"next"});this.prev_month_button=header_div.build("a",{innerHTML:"&lt;",href:"#",onclick:function(){this.navMonth(this.date.getMonth()-1);return false;}.bindAsEventListener(this),className:"prev"});if(this.options.get("month_year")=="dropdowns"){this.month_select=new SelectBox(header_div,$R(0,11).map(function(m){return[Date.months[m],m]}),{className:"month",onchange:function(){this.navMonth(this.month_select.getValue())}.bindAsEventListener(this)});this.year_select=new SelectBox(header_div,[],{className:"year",onchange:function(){this.navYear(this.year_select.getValue())}.bindAsEventListener(this)});this.populateYearRange();}else{this.month_year_label=header_div.build("span")}},initCalendarGrid:function(){var body_div=this.body_div;this.calendar_day_grid=[];var days_table=body_div.build("table",{cellPadding:"0px",cellSpacing:"0px",width:"100%"})
var weekdays_row=days_table.build("thead").build("tr");Date.weekdays.each(function(weekday){weekdays_row.build("th",{innerHTML:weekday});});var days_tbody=days_table.build("tbody")
var row_number=0,weekday;for(var cell_index=0;cell_index<42;cell_index++)
{weekday=(cell_index+Date.first_day_of_week)%7;if(cell_index%7==0)days_row=days_tbody.build("tr",{className:'row_'+row_number++});(this.calendar_day_grid[cell_index]=days_row.build("td",{calendar_date_select:this,onmouseover:function(){this.calendar_date_select.dayHover(this);},onmouseout:function(){this.calendar_date_select.dayHoverOut(this)},onclick:function(){this.calendar_date_select.updateSelectedDate(this,true);},className:(weekday==0)||(weekday==6)?" weekend":""},{cursor:"pointer"})).build("div");this.calendar_day_grid[cell_index];}},initButtonsDiv:function()
{var buttons_div=this.buttons_div;if(this.options.get("time"))
{var blank_time=$A(this.options.get("time")=="mixed"?[[" - ",""]]:[]);buttons_div.build("span",{innerHTML:"@",className:"at_sign"});var t=new Date();this.hour_select=new SelectBox(buttons_div,blank_time.concat($R(0,23).map(function(x){t.setHours(x);return $A([t.getAMPMHour()+" "+t.getAMPM(),x])})),{calendar_date_select:this,onchange:function(){this.calendar_date_select.updateSelectedDate({hour:this.value});},className:"hour"});buttons_div.build("span",{innerHTML:":",className:"seperator"});var that=this;this.minute_select=new SelectBox(buttons_div,blank_time.concat($R(0,59).select(function(x){return(x%that.options.get('minute_interval')==0)}).map(function(x){return $A([Date.padded2(x),x]);})),{calendar_date_select:this,onchange:function(){this.calendar_date_select.updateSelectedDate({minute:this.value})},className:"minute"});}else if(!this.options.get("buttons"))buttons_div.remove();if(this.options.get("buttons")){buttons_div.build("span",{innerHTML:"&#160;"});if(this.options.get("time")=="mixed"||!this.options.get("time"))b=buttons_div.build("a",{innerHTML:_translations["Today"],href:"#",onclick:function(){this.today(false);return false;}.bindAsEventListener(this)});if(this.options.get("time")=="mixed")buttons_div.build("span",{innerHTML:"&#160;|&#160;",className:"button_seperator"})
if(this.options.get("time"))b=buttons_div.build("a",{innerHTML:_translations["Now"],href:"#",onclick:function(){this.today(true);return false}.bindAsEventListener(this)});if(!this.options.get("embedded")&&!this.closeOnClick())
{buttons_div.build("span",{innerHTML:"&#160;|&#160;",className:"button_seperator"})
buttons_div.build("a",{innerHTML:_translations["OK"],href:"#",onclick:function(){this.close();return false;}.bindAsEventListener(this)});}
if(this.options.get('clear_button')){buttons_div.build("span",{innerHTML:"&#160;|&#160;",className:"button_seperator"})
buttons_div.build("a",{innerHTML:_translations["Clear"],href:"#",onclick:function(){this.clearDate();if(!this.options.get("embedded"))this.close();return false;}.bindAsEventListener(this)});}}},refresh:function()
{this.refreshMonthYear();this.refreshCalendarGrid();this.setSelectedClass();this.updateFooter();},refreshCalendarGrid:function(){this.beginning_date=new Date(this.date).stripTime();this.beginning_date.setDate(1);this.beginning_date.setHours(12);var pre_days=this.beginning_date.getDay()
if(pre_days<3)pre_days+=7;this.beginning_date.setDate(1-pre_days+Date.first_day_of_week);var iterator=new Date(this.beginning_date);var today=new Date().stripTime();var this_month=this.date.getMonth();vdc=this.options.get("valid_date_check");for(var cell_index=0;cell_index<42;cell_index++)
{day=iterator.getDate();month=iterator.getMonth();cell=this.calendar_day_grid[cell_index];Element.remove(cell.childNodes[0]);div=cell.build("div",{innerHTML:day});if(month!=this_month)div.className="other";cell.day=day;cell.month=month;cell.year=iterator.getFullYear();if(vdc){if(vdc(iterator.stripTime()))cell.removeClassName("disabled");else cell.addClassName("disabled")};iterator.setDate(day+1);}
if(this.today_cell)this.today_cell.removeClassName("today");if($R(0,41).include(days_until=this.beginning_date.stripTime().daysDistance(today))){this.today_cell=this.calendar_day_grid[days_until];this.today_cell.addClassName("today");}},refreshMonthYear:function(){var m=this.date.getMonth();var y=this.date.getFullYear();if(this.options.get("month_year")=="dropdowns")
{this.month_select.setValue(m,false);var e=this.year_select.element;if(this.flexibleYearRange()&&(!(this.year_select.setValue(y,false))||e.selectedIndex<=1||e.selectedIndex>=e.options.length-2))this.populateYearRange();this.year_select.setValue(y);}else{this.month_year_label.update(Date.months[m]+" "+y.toString());}},populateYearRange:function(){this.year_select.populate(this.yearRange().toArray());},yearRange:function(){if(!this.flexibleYearRange())
return $R(this.options.get("year_range")[0],this.options.get("year_range")[1]);var y=this.date.getFullYear();return $R(y-this.options.get("year_range"),y+this.options.get("year_range"));},flexibleYearRange:function(){return(typeof(this.options.get("year_range"))=="number");},validYear:function(year){if(this.flexibleYearRange()){return true;}else{return this.yearRange().include(year);}},dayHover:function(element){var hover_date=new Date(this.selected_date);hover_date.setYear(element.year);hover_date.setMonth(element.month);hover_date.setDate(element.day);this.updateFooter(hover_date.toFormattedString(this.use_time));},dayHoverOut:function(element){this.updateFooter();},clearSelectedClass:function(){if(this.selected_cell)this.selected_cell.removeClassName("selected");},setSelectedClass:function(){if(!this.selection_made)return;this.clearSelectedClass()
if($R(0,42).include(days_until=this.beginning_date.stripTime().daysDistance(this.selected_date.stripTime()))){this.selected_cell=this.calendar_day_grid[days_until];this.selected_cell.addClassName("selected");}},reparse:function(){this.parseDate();this.refresh();},dateString:function(){return(this.selection_made)?this.selected_date.toFormattedString(this.use_time):"&#160;";},parseDate:function()
{var value=$F(this.target_element).strip()
var default_time=this.options.get("default_time");this.selection_made=(value!=""||default_time);this.date=value==""?NaN:Date.parseFormattedString(this.options.get("date")||value);if(isNaN(this.date)&&!default_time)
this.date=new Date();else if(isNaN(this.date)&&default_time)
this.date=(Object.prototype.toString.apply(default_time)==='[object Function]')?default_time():default_time;if(!this.validYear(this.date.getFullYear()))this.date.setYear((this.date.getFullYear()<this.yearRange().start)?this.yearRange().start:this.yearRange().end);this.selected_date=new Date(this.date);this.use_time=/[0-9]:[0-9]{2}/.exec(value)?true:false;this.date.setDate(1);},updateFooter:function(text){if(!text)text=this.dateString();this.footer_div.purgeChildren();this.footer_div.build("span",{innerHTML:text});},clearDate:function(){if((this.target_element.disabled||this.target_element.readOnly)&&this.options.get("popup")!="force")return false;var last_value=this.target_element.value;this.target_element.value="";this.clearSelectedClass();this.updateFooter('&#160;');if(last_value!=this.target_element.value)this.callback("onchange");},updateSelectedDate:function(partsOrElement,via_click){var parts=$H(partsOrElement);if((this.target_element.disabled||this.target_element.readOnly)&&this.options.get("popup")!="force")return false;if(parts.get("day")){var t_selected_date=this.selected_date,vdc=this.options.get("valid_date_check");t_selected_date.setYear(parts.get("year"));t_selected_date.setMonth(parts.get("month"));t_selected_date.setDate(parts.get("day"));if(vdc&&!vdc(t_selected_date.stripTime())){return false;}
this.selected_date=t_selected_date;this.selection_made=true;}
if(!isNaN(parts.get("hour")))this.selected_date.setHours(parts.get("hour"));if(!isNaN(parts.get("minute")))this.selected_date.setMinutes(Math.floor_to_interval(parts.get("minute"),this.options.get("minute_interval")));if(parts.get("hour")===""||parts.get("minute")==="")
this.setUseTime(false);else if(!isNaN(parts.get("hour"))||!isNaN(parts.get("minute")))
this.setUseTime(true);this.updateFooter();this.setSelectedClass();if(this.selection_made)this.updateValue();if(this.closeOnClick()){this.close();}
if(via_click&&!this.options.get("embedded")){if((new Date()-this.last_click_at)<333)this.close();this.last_click_at=new Date();}},closeOnClick:function(){if(this.options.get("embedded"))return false;if(this.options.get("close_on_click")===nil)
return(this.options.get("time"))?false:true
else
return(this.options.get("close_on_click"))},navMonth:function(month){(target_date=new Date(this.date)).setMonth(month);return(this.navTo(target_date));},navYear:function(year){(target_date=new Date(this.date)).setYear(year);return(this.navTo(target_date));},navTo:function(date){if(!this.validYear(date.getFullYear()))return false;this.date=date;this.date.setDate(1);this.refresh();this.callback("after_navigate",this.date);return true;},setUseTime:function(turn_on){this.use_time=this.options.get("time")&&(this.options.get("time")=="mixed"?turn_on:true)
if(this.use_time&&this.selected_date){var minute=Math.floor_to_interval(this.selected_date.getMinutes(),this.options.get("minute_interval"));var hour=this.selected_date.getHours();this.hour_select.setValue(hour);this.minute_select.setValue(minute)}else if(this.options.get("time")=="mixed"){this.hour_select.setValue("");this.minute_select.setValue("");}},updateValue:function(){var last_value=this.target_element.value;this.target_element.value=this.dateString();if(last_value!=this.target_element.value)this.callback("onchange");},today:function(now){var d=new Date();this.date=new Date();var o=$H({day:d.getDate(),month:d.getMonth(),year:d.getFullYear(),hour:d.getHours(),minute:d.getMinutes()});if(!now)o=o.merge({hour:"",minute:""});this.updateSelectedDate(o,true);this.refresh();},close:function(){if(this.closed)return false;this.callback("before_close");this.target_element.calendar_date_select=nil;Event.stopObserving(document,"mousedown",this.closeIfClickedOut_handler);Event.stopObserving(document,"keypress",this.keyPress_handler);this.calendar_div.remove();this.closed=true;if(this.iframe)this.iframe.remove();if(this.target_element.type!="hidden"&&!this.target_element.disabled)this.target_element.focus();this.callback("after_close");},closeIfClickedOut:function(e){if(!$(Event.element(e)).descendantOf(this.calendar_div))this.close();},keyPress:function(e){if(e.keyCode==Event.KEY_ESC)this.close();},callback:function(name,param){if(this.options.get(name)){this.options.get(name).bind(this.target_element)(param);}}}